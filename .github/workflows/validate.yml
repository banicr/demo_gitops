name: Validate GitOps Manifests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  # Job 1: Helm Linting
  helm-lint:
    name: Helm Chart Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Lint Helm chart
        run: |
          echo "ðŸ” Running Helm lint with strict mode..."
          helm lint helm/demo-flask-app --strict
          echo "âœ… Helm lint passed!"

      - name: Lint summary
        run: |
          echo "### âœ… Helm Linting Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Chart is properly formatted and follows best practices" >> $GITHUB_STEP_SUMMARY

  # Job 2: Validate Helm Templates
  helm-validate:
    name: Helm Template Validation
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Validate Helm template rendering
        run: |
          echo "ðŸ” Rendering Helm templates..."
          helm template demo-flask-app helm/demo-flask-app > /tmp/rendered-manifest.yaml
          
          LINES=$(wc -l < /tmp/rendered-manifest.yaml)
          echo "âœ… Successfully rendered $LINES lines of Kubernetes manifests"

      - name: Check for required resources
        run: |
          echo "ðŸ” Checking for required Kubernetes resources..."
          
          # Check for Deployment
          if grep -q "kind: Deployment" /tmp/rendered-manifest.yaml; then
            echo "âœ… Deployment found"
          else
            echo "âŒ Deployment not found"
            exit 1
          fi
          
          # Check for Service
          if grep -q "kind: Service" /tmp/rendered-manifest.yaml; then
            echo "âœ… Service found"
          else
            echo "âŒ Service not found"
            exit 1
          fi

      - name: Validate manifest structure
        run: |
          echo "ðŸ” Validating YAML structure..."
          
          # Check for valid YAML
          python3 -c "import yaml; yaml.safe_load_all(open('/tmp/rendered-manifest.yaml'))"
          echo "âœ… YAML structure is valid"

      - name: Upload rendered manifests
        uses: actions/upload-artifact@v4
        with:
          name: rendered-manifests
          path: /tmp/rendered-manifest.yaml
          retention-days: 7

      - name: Validation summary
        run: |
          echo "### âœ… Helm Template Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Template Rendering**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Required Resources**: âœ… All present" >> $GITHUB_STEP_SUMMARY
          echo "- **YAML Structure**: âœ… Valid" >> $GITHUB_STEP_SUMMARY

  # Job 3: Kubernetes Manifest Validation
  k8s-validate:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    needs: helm-validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install kubeval
        run: |
          echo "ðŸ“¦ Installing kubeval..."
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          kubeval --version
          echo "âœ… kubeval installed"

      - name: Validate Kubernetes manifests
        run: |
          echo "ðŸ” Validating Kubernetes manifests with kubeval..."
          
          helm template demo-flask-app helm/demo-flask-app | \
            kubeval --strict --ignore-missing-schemas --kubernetes-version 1.28.0
          
          echo "âœ… Kubernetes manifest validation passed!"

      - name: Install kubeconform (alternative validator)
        run: |
          echo "ðŸ“¦ Installing kubeconform..."
          wget -q https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin
          echo "âœ… kubeconform installed"

      - name: Validate with kubeconform
        run: |
          echo "ðŸ” Validating with kubeconform..."
          
          helm template demo-flask-app helm/demo-flask-app | \
            kubeconform -strict -summary -kubernetes-version 1.28.0
          
          echo "âœ… kubeconform validation passed!"

      - name: K8s validation summary
        run: |
          echo "### âœ… Kubernetes Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **kubeval**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **kubeconform**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Kubernetes resources conform to API specifications" >> $GITHUB_STEP_SUMMARY

  # Job 4: Security & Best Practices Check
  security-check:
    name: Security & Best Practices
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Check for security contexts
        run: |
          echo "ðŸ” Checking for security contexts..."
          
          helm template demo-flask-app helm/demo-flask-app > /tmp/manifest.yaml
          
          # Check for runAsNonRoot
          if grep -q "runAsNonRoot: true" /tmp/manifest.yaml; then
            echo "âœ… runAsNonRoot is set"
          else
            echo "âš ï¸  runAsNonRoot not found"
          fi
          
          # Check for dropped capabilities
          if grep -q "drop:" /tmp/manifest.yaml; then
            echo "âœ… Capabilities are being dropped"
          else
            echo "âš ï¸  No capability drops found"
          fi
          
          # Check for resource limits
          if grep -q "limits:" /tmp/manifest.yaml; then
            echo "âœ… Resource limits are set"
          else
            echo "âŒ Resource limits not found"
            exit 1
          fi

      - name: Check for probes
        run: |
          echo "ðŸ” Checking for health probes..."
          
          # Check for liveness probe
          if grep -q "livenessProbe:" /tmp/manifest.yaml; then
            echo "âœ… Liveness probe configured"
          else
            echo "âŒ Liveness probe not found"
            exit 1
          fi
          
          # Check for readiness probe
          if grep -q "readinessProbe:" /tmp/manifest.yaml; then
            echo "âœ… Readiness probe configured"
          else
            echo "âŒ Readiness probe not found"
            exit 1
          fi

      - name: Check replica count
        run: |
          echo "ðŸ” Checking replica count..."
          
          REPLICAS=$(grep "replicaCount:" helm/demo-flask-app/values.yaml | awk '{print $2}')
          
          if [ "$REPLICAS" -ge 2 ]; then
            echo "âœ… High availability with $REPLICAS replicas"
          else
            echo "âš ï¸  Only $REPLICAS replica(s) configured"
          fi

      - name: Security summary
        run: |
          echo "### âœ… Security Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Contexts**: âœ… Configured" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Limits**: âœ… Set" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Probes**: âœ… Configured" >> $GITHUB_STEP_SUMMARY
          echo "- **High Availability**: âœ… Multiple replicas" >> $GITHUB_STEP_SUMMARY

  # Job 5: ArgoCD Application Validation
  argocd-validate:
    name: ArgoCD Application Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate ArgoCD Application manifest
        run: |
          echo "ðŸ” Validating ArgoCD Application manifest..."
          
          # Check if file exists
          if [ ! -f "argocd-application.yaml" ]; then
            echo "âŒ argocd-application.yaml not found"
            exit 1
          fi
          
          # Validate YAML syntax
          python3 -c "import yaml; yaml.safe_load(open('argocd-application.yaml'))"
          echo "âœ… ArgoCD Application YAML is valid"

      - name: Check ArgoCD Application structure
        run: |
          echo "ðŸ” Checking ArgoCD Application structure..."
          
          # Check for required fields
          if grep -q "apiVersion: argoproj.io/v1alpha1" argocd-application.yaml; then
            echo "âœ… Correct API version"
          else
            echo "âŒ Invalid API version"
            exit 1
          fi
          
          if grep -q "kind: Application" argocd-application.yaml; then
            echo "âœ… Correct kind"
          else
            echo "âŒ Invalid kind"
            exit 1
          fi
          
          if grep -q "syncPolicy:" argocd-application.yaml; then
            echo "âœ… Sync policy configured"
          else
            echo "âš ï¸  No sync policy found"
          fi

      - name: ArgoCD validation summary
        run: |
          echo "### âœ… ArgoCD Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD Application manifest is valid and well-formed" >> $GITHUB_STEP_SUMMARY

  # Job 6: Final Summary
  final-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [helm-lint, helm-validate, k8s-validate, security-check, argocd-validate]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "ðŸŽ‰ All validation checks completed!"
          echo ""
          echo "### ðŸŽ‰ All Validations Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Linting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Template Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GitOps repository is ready for deployment** ðŸš€" >> $GITHUB_STEP_SUMMARY
